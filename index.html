<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absensi Taruna TPI F — Final</title>
  <style>
    :root{--bg1:#667eea;--bg2:#764ba2;--accent:#3498db;--green:#27ae60}
    body{font-family:Inter, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; margin:0;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2)100%);padding:18px}
    .container{max-width:1100px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,.12);overflow:hidden}
    .header{background:linear-gradient(45deg,#2c3e50,var(--accent));color:#fff;padding:20px;text-align:center}
    .header h1{margin:0;font-weight:300;font-size:1.6rem}
    .header p{margin:6px 0 0 0;opacity:.9}
    .content{padding:22px}
    .table-container{overflow-x:auto;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:18px}
    table{width:100%;border-collapse:collapse;background:#fff}
    th{background:linear-gradient(45deg,#34495e,#2c3e50);color:#fff;padding:10px;text-align:left;position:sticky;top:0}
    td{padding:10px;border-bottom:1px solid #eef2f6}
    select{padding:6px;border-radius:6px;border:1px solid #d1d8e0;cursor:pointer}
    .stats{display:flex;gap:12px;margin:18px 0;overflow-x:auto;padding-bottom:6px}
    .stat-card{min-width:160px;flex:0 0 auto;background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;padding:14px;border-radius:10px;text-align:center;box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .stat-number{font-size:1.6rem;font-weight:700}
    .lists-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:10px}
    .list-section{background:#f8f9fa;padding:12px;border-radius:10px;border-left:5px solid var(--accent)}
    .list-section h3{margin:0 0 8px 0;display:flex;align-items:center;justify-content:space-between}
    .name-list{max-height:220px;overflow:auto;background:#fff;padding:8px;border-radius:6px}
    .name-item{padding:6px 4px;border-bottom:1px solid #eef2f6}
    .name-item:last-child{border-bottom:none}
    .placeholder{font-style:italic;color:#7f8c8d;text-align:center}
    .btn-row{text-align:center;margin-top:18px}
    .btn{display:inline-block;border:none;padding:12px 28px;border-radius:40px;color:#fff;font-weight:700;cursor:pointer;margin:6px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .btn-reset{background:linear-gradient(45deg,#f39c12,#f1c40f)}
    .btn-wa{background:linear-gradient(45deg,var(--green),#2ecc71)}
    .btn-camera{background:linear-gradient(45deg,#2980b9,#3498db)}
    .btn-save{background:linear-gradient(45deg,#16a085,#1abc9c)}
    /* Camera preview */
    #preview{margin-top:12px;text-align:center}
    #photo{max-width:100%;border-radius:8px;display:none;margin-top:10px}
    /* small screens keep horizontal scroll for stats */
    @media (max-width:540px){ .stat-card{min-width:200px} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>⚓ Absensi Taruna TPI Foxtrot</h1>
      <p>Rekap via WhatsApp + Tagging</p>
      <p>by.@fthrrzl_qa</p>
    </div>

    <div class="content">
      <!-- DAFTAR -->
      <div class="preview-section">
        <h2 style="margin:0 0 10px 0">📋 Preview Daftar Hadir</h2>
        <div class="table-container">
          <table id="attendanceTable" aria-label="attendance table">
            <thead>
              <tr><th style="width:60px">No</th><th>Nama Taruna</th><th style="width:120px">NRP</th><th style="width:160px">Status</th></tr>
            </thead>
            <tbody id="attendanceBody"></tbody>
          </table>
        </div>
      </div>

      <!-- STAT -->
      <div class="preview-section">
        <h2 style="margin:0 0 10px 0">📊 Rekap Absensi Real-time</h2>
        <div class="stats" id="statsRow">
          <div class="stat-card"><div class="stat-number" id="totalHadir">0</div><div class="stat-label">Hadir</div></div>
          <div class="stat-card"><div class="stat-number" id="totalAbsen">0</div><div class="stat-label">Tidak Hadir</div></div>
          <div class="stat-card"><div class="stat-number" id="totalIzin">0</div><div class="stat-label">Izin</div></div>
        </div>

        <!-- LISTS -->
        <div class="lists-container">
          <div class="list-section">
            <h3>✅ Hadir <span style="cursor:pointer" title="Copy" onclick="copyList('hadir')">📋</span></h3>
            <div class="name-list" id="hadirList"><div class="name-item placeholder">Belum ada yang hadir</div></div>
          </div>
          <div class="list-section">
            <h3>❌ Tidak Hadir <span style="cursor:pointer" title="Copy" onclick="copyList('absen')">📋</span></h3>
            <div class="name-list" id="absenList"><div class="name-item placeholder">Semua taruna hadir</div></div>
          </div>
          <div class="list-section">
            <h3>🟡 Izin <span style="cursor:pointer" title="Copy" onclick="copyList('izin')">📋</span></h3>
            <div class="name-list" id="izinList"><div class="name-item placeholder">Tidak ada izin</div></div>
          </div>
        </div>
      </div>

      <!-- CAMERA -->
      <div style="margin-top:16px">
        <input type="file" accept="image/*" capture="environment" id="cameraInput" style="display:none">
        <button class="btn btn-camera" onclick="document.getElementById('cameraInput').click()">📷 Ambil Foto Absensi</button>
        <div id="preview">
          <canvas id="canvas" style="display:none"></canvas>
          <img id="photo" alt="Foto hasil jepretan">
        </div>
        <div style="text-align:center;margin-top:10px">
          <button id="saveBtn" class="btn btn-save" style="display:none" onclick="savePhoto()">💾 Simpan Foto (dengan timestamp)</button>
        </div>
      </div>

      <!-- ACTION -->
      <div class="btn-row">
        <button class="btn btn-reset" onclick="resetStatus()">🔄 Reset Absensi</button>
        <button class="btn btn-wa" onclick="sendWhatsApp()">📲 Kirim Rekapan via WhatsApp</button>
      </div>
    </div>
  </div>

<script>
/* ===== DATA TARUNA (lengkap 40) ===== */
const tarunaData = [
  {no:1,nama:"Ade James Bill Kevin Hati",nrp:"59231115241"},
  {no:2,nama:"Afwan Fauzan S",nrp:"59231115242"},
  {no:3,nama:"Ahmad Irfan Pebrivan",nrp:"59231115484"},
  {no:4,nama:"Al Mubarak",nrp:"59231114849"},
  {no:5,nama:"Alman Faluti",nrp:"59231115486"},
  {no:6,nama:"Andi Zaidin Raub",nrp:"59231115645"},
  {no:7,nama:"Arya Bayu Pratama",nrp:"59231115648"},
  {no:8,nama:"Calvin Svadef",nrp:"59231115248"},
  {no:9,nama:"Danu Pramana",nrp:"59231114857"},
  {no:10,nama:"Dino Perdian",nrp:"59231115427"},
  {no:11,nama:"Elang Sakti Massaid",nrp:"59231115497"},
  {no:12,nama:"Faris Arva Makarim",nrp:"59234115409"},
  {no:13,nama:"Figsan Fanshury Roja",nrp:"59231115501"},
  {no:14,nama:"Frizzy Fawwaz Zakv",nrp:"59231115428"},
  {no:15,nama:"Hadrianto",nrp:"59231115663"},
  {no:16,nama:"Heribertus Bili",nrp:"59231115264"},
  {no:17,nama:"Ilham Ihsani",nrp:"59231115268"},
  {no:18,nama:"Jastin Sahertian",nrp:"59231115671"},
  {no:19,nama:"Juan Dito Latuheru",nrp:"59231115675"},
  {no:20,nama:"Kodri Azizi Rahakbauw",nrp:"59231115676"},
  {no:21,nama:"Luthfi Ernando",nrp:"59231115515"},
  {no:22,nama:"M. Wahyu Effendi",nrp:"59231115160"},
  {no:23,nama:"Mas Rianto",nrp:"59231115518"},
  {no:24,nama:"Mohammad Syahdilah Munasvar",nrp:"59231115282"},
  {no:25,nama:"Muhamad Fatkhurrizal Ourrota A",nrp:"59231115279"},
  {no:26,nama:"Muhammad Fachrie Winarno",nrp:"59231114875"},
  {no:27,nama:"Muhammad Naimi Nidarahman",nrp:"59231115527"},
  {no:28,nama:"Muhammad Sam Azis",nrp:"59231115289"},
  {no:29,nama:"Nanda Syahputra",nrp:"59231115800"},
  {no:30,nama:"Rafael Dara Jaha Baghi",nrp:"59231115291"},
  {no:31,nama:"Rangga Irvanda",nrp:"59231115295"},
  {no:32,nama:"Ridho Ahmad Wellete",nrp:"59231115695"},
  {no:33,nama:"Riski",nrp:"59231115697"},
  {no:34,nama:"Rizqy Ari Murti",nrp:"59231115801"},
  {no:35,nama:"Samsudin Kotala",nrp:"59231115702"},
  {no:36,nama:"Sheva Dwi Fatkhurrohman",nrp:"59231115536"},
  {no:37,nama:"Sulthan Nadhif Darmawan",nrp:"59231115538"},
  {no:38,nama:"T. Ibnu Sina",nrp:"59231115191"},
  {no:39,nama:"Yahya Solissa",nrp:"59231115711"},
  {no:40,nama:"Zakarias Lede Bulu",nrp:"59231115314"}
];

/* ===== INIT TABLE ===== */
function initializeTable(){
  const tbody = document.getElementById('attendanceBody');
  tbody.innerHTML = '';
  tarunaData.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.no}</td>
      <td>${t.nama}</td>
      <td>${t.nrp}</td>
      <td>
        <select id="status_${t.no}" onchange="updateStats()">
          <option value="absen">❌ Tidak Hadir</option>
          <option value="hadir">✅ Hadir</option>
          <option value="izin">🟡 Izin</option>
        </select>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ===== UPDATE STATS & LISTS ===== */
function updateStats(){
  const selects = Array.from(document.querySelectorAll('select[id^="status_"]'));
  let hadir=0, absen=0, izin=0;
  const hadirNames=[], absenNames=[], izinNames=[];
  selects.forEach((sel,i)=>{
    const nama = tarunaData[i].nama;
    if(sel.value==='hadir'){ hadir++; hadirNames.push(nama); }
    else if(sel.value==='izin'){ izin++; izinNames.push(nama); }
    else { absen++; absenNames.push(nama); }
  });

  document.getElementById('totalHadir').textContent = hadir;
  document.getElementById('totalAbsen').textContent = absen;
  document.getElementById('totalIzin').textContent = izin;

  const hadirList = document.getElementById('hadirList');
  const absenList = document.getElementById('absenList');
  const izinList = document.getElementById('izinList');

  hadirList.innerHTML = hadirNames.length ? hadirNames.map(n=>`<div class="name-item">${n}</div>`).join('') : '<div class="name-item placeholder">Belum ada yang hadir</div>';
  absenList.innerHTML = absenNames.length ? absenNames.map(n=>`<div class="name-item">${n}</div>`).join('') : '<div class="name-item placeholder">Semua taruna hadir</div>';
  izinList.innerHTML = izinNames.length ? izinNames.map(n=>`<div class="name-item">${n}</div>`).join('') : '<div class="name-item placeholder">Tidak ada izin</div>';
}

/* ===== RESET (confirm) ===== */
function resetStatus(){
  if(!confirm('Yakin reset absensi?')) return;
  document.querySelectorAll('select[id^="status_"]').forEach(s=>s.value='absen');
  updateStats();
}

/* ===== COPY LIST (skip placeholder) ===== */
function copyList(type){
  const el = document.getElementById(type+'List');
  const items = Array.from(el.querySelectorAll('.name-item'));
  const real = items.filter(it => !it.classList.contains('placeholder')).map(it=>it.textContent.trim());
  if(real.length===0){ alert('Belum ada data untuk dicopy!'); return; }
  const text = real.map((n,i)=>`${i+1}. ${n}`).join('\n');
  navigator.clipboard.writeText(text).then(()=>alert('Daftar '+type+' berhasil dicopy!'));
}

/* ===== SEND WHATSAPP with template (cancel stops) ===== */
function sendWhatsApp(){
  const total = tarunaData.length;
  const selects = Array.from(document.querySelectorAll('select[id^="status_"]'));
  let hadir=0, absen=0, izin=0;
  const hadirNames=[], absenNames=[], izinNames=[];
  selects.forEach((sel,i)=>{
    const nama = tarunaData[i].nama;
    if(sel.value==='hadir'){ hadir++; hadirNames.push(nama); }
    else if(sel.value==='izin'){ izin++; izinNames.push(nama); }
    else { absen++; absenNames.push(nama); }
  });

  // waktu lengkap (jam:menit:detik)
  const now = new Date();
  const jam = now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const tanggal = now.toLocaleDateString('id-ID',{day:'numeric',month:'long',year:'numeric'});

  let message = `Rekap apel (${jam} - ${tanggal}) TPI F

Total : ${total}
Hadir : ${hadir}
Tidak hadir : ${absen}
Izin : ${izin}

Keterangan :`;

  if(absenNames.length>0){
    message += `\nA. Tidak hadir`;
    absenNames.forEach((n,i)=> message += `\n${i+1}. ${n}`);
  }
  if(izinNames.length>0){
    message += `\n\nB. Izin`;
    izinNames.forEach((n,i)=> message += `\n${i+1}. ${n}`);
  }

  // tambahan opsional
  const tambahan = prompt('Tambahkan keterangan lainnya (opsional):','');
  if(tambahan === null) return; // BATAL -> stop
  if(tambahan.trim()!=='') message += `\n\nCatatan tambahan: ${tambahan.trim()}`;

  const waUrl = 'https://wa.me/?text='+encodeURIComponent(message);
  window.open(waUrl,'_blank');
}

/* ===== CAMERA + TIMESTAMP + GPS (no external API) ===== */
const input = document.getElementById('cameraInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const photo = document.getElementById('photo');
const saveBtn = document.getElementById('saveBtn');

input.addEventListener('change', async function(e){
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const img = new Image();
    img.onload = async function(){
      // set canvas size (limit to reasonable width to avoid too huge)
      const maxW = 1200;
      const scale = img.width > maxW ? maxW / img.width : 1;
      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0,canvas.width,canvas.height);

      // capture timestamp
      const now = new Date();
      const tanggalJam = now.toLocaleString('id-ID', {
        day:'numeric', month:'long', year:'numeric',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      });

      // try to get geolocation (with timeout)
      let coordsText = 'Koordinat: unavailable';
      try {
        const pos = await getCurrentPosition({enableHighAccuracy:true, timeout:8000, maximumAge:0});
        const lat = pos.coords.latitude.toFixed(6);
        const lon = pos.coords.longitude.toFixed(6);
        coordsText = `Koordinat: ${lat}, ${lon}`;
      } catch(err){
        // gagal/minta izin ditolak => tetep lanjut dengan unavailable
        coordsText = 'Koordinat: tidak tersedia';
      }

      // draw background rectangle for readability
      const pad = 18;
      ctx.font = 'bold 36px Arial';
      // measure texts
      const ts = `Timestamp: ${tanggalJam}`;
      const cs = coordsText;
      const tsWidth = ctx.measureText(ts).width;
      const csWidth = ctx.measureText(cs).width;
      const rectW = Math.max(tsWidth, csWidth) + pad*2;
      const rectH = 36*2 + pad; // two lines
      const x = 20;
      const y = canvas.height - rectH - 20;
      ctx.fillStyle = 'rgba(0,0,0,0.55)';
      ctx.fillRect(x-10, y-10, rectW+20, rectH+20);

      // draw timestamp (bigger)
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 32px Arial';
      ctx.fillText(ts, x, y + 36);
      ctx.font = '20px Arial';
      ctx.fillText(cs, x, y + 36 + 34);

      // set preview
      photo.src = canvas.toDataURL('image/png');
      photo.style.display = 'block';
      saveBtn.style.display = 'inline-block';
      // scroll to photo (mobile)
      photo.scrollIntoView({behavior:'smooth',block:'center'});
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// helper getCurrentPosition -> Promise
function getCurrentPosition(options){
  return new Promise((resolve, reject) => {
    if(!navigator.geolocation) return reject(new Error('No geolocation'));
    navigator.geolocation.getCurrentPosition(resolve, reject, options);
  });
}

// save photo to device
function savePhoto(){
  try {
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = `absensi_${Date.now()}.png`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    alert('✅ Foto lengkap dengan timestamp & koordinat berhasil disimpan. Silakan lampirkan ke WhatsApp.');
  } catch(e){
    alert('Gagal menyimpan foto: '+ (e.message || e));
  }
}

/* ===== init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  initializeTable();
  updateStats();
});
</script>
</body>
</html>